{{ define "main" }}
<div class="gallery-grid-container">
    {{ $photos := where .Site.RegularPages "Section" "view" }}
    {{ if gt (len $photos) 0 }}
    <div class="gallery-grid" id="gallery-grid">
        {{ range $index, $photo := $photos }}
        <a href="{{ .RelPermalink }}" class="gallery-item">
            <div class="gallery-thumbnail">
                {{ with .Params.image }}
                    {{ $original := resources.Get . }}
                    {{ if $original }}
                        {{ $thumbnail := $original.Resize "600x jpg q80" }}
                        {{ $isAboveFold := lt $index 8 }}
                        <div class="image-wrapper">
                            <img class="gallery-img"
                                 src="{{ $thumbnail.RelPermalink }}"
                                 alt="{{ $photo.Title }}"
                                 width="{{ $thumbnail.Width }}"
                                 height="{{ $thumbnail.Height }}"
                                 decoding="async"
                                 {{ if $isAboveFold }}fetchpriority="high"{{ end }}
                                 loading="eager">
                        </div>
                    {{ else }}
                        <div class="image-wrapper image-loaded">
                            <img class="gallery-img"
                                 src="{{ . | relURL }}"
                                 alt="{{ $photo.Title }}"
                                 loading="eager">
                        </div>
                    {{ end }}
                {{ end }}
            </div>
        </a>
        {{ end }}
    </div>
    {{ else }}
    <p>No photos available yet.</p>
    {{ end }}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const grid = document.getElementById('gallery-grid');
    if (!grid) return;

    const originalItems = Array.from(grid.querySelectorAll('.gallery-item'));
    if (originalItems.length === 0) return;

    const getColumnCount = () => window.matchMedia('(min-width: 768px)').matches ? 4 : 2;

    const renderMasonry = () => {
        const columnCount = getColumnCount();
        const fragment = document.createDocumentFragment();
        const columns = [];

        for (let i = 0; i < columnCount; i++) {
            const column = document.createElement('div');
            column.className = 'gallery-column';
            fragment.appendChild(column);
            columns.push(column);
        }

        originalItems.forEach((item, index) => {
            columns[index % columnCount].appendChild(item);
        });

        grid.replaceChildren(fragment);
    };

    let lastColumnCount = getColumnCount();
    renderMasonry();

    let resizeTimer = null;
    window.addEventListener('resize', function() {
        window.clearTimeout(resizeTimer);
        resizeTimer = window.setTimeout(function() {
            const current = getColumnCount();
            if (current !== lastColumnCount) {
                lastColumnCount = current;
                renderMasonry();
            }
        }, 120);
    });
});
</script>

{{ end }} 
