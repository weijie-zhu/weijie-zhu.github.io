{{ define "main" }}
<div class="gallery-grid-container">
    {{ $photos := where .Site.RegularPages "Section" "view" }}
    {{ if gt (len $photos) 0 }}
    <div class="gallery-grid" id="gallery-grid">
        {{ range $index, $photo := $photos }}
        <a href="{{ .RelPermalink }}" class="gallery-item">
            <div class="gallery-thumbnail">
                {{ with .Params.image }}
                    {{ $original := resources.Get . }}
                    {{ if $original }}
                        {{ $thumbnail := $original.Resize "600x jpg q80" }}
                        {{ $placeholder := $original.Resize "20x jpg q20" }}
                        {{ $isAboveFold := lt $index 8 }}
                        <div class="image-wrapper">
                            <img class="gallery-img gallery-img-loading"
                                 src="{{ $placeholder.RelPermalink }}"
                                 data-src="{{ $thumbnail.RelPermalink }}"
                                 alt="{{ $.Title }}"
                                 width="{{ $thumbnail.Width }}"
                                 height="{{ $thumbnail.Height }}"
                                 {{ if not $isAboveFold }}loading="lazy"{{ end }}>
                        </div>
                    {{ else }}
                        <div class="image-wrapper">
                            <img class="gallery-img"
                                 src="{{ . }}"
                                 alt="{{ $.Title }}"
                                 loading="lazy">
                        </div>
                    {{ end }}
                {{ end }}
            </div>
        </a>
        {{ end }}
    </div>
    {{ else }}
    <p>No photos available yet.</p>
    {{ end }}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const images = document.querySelectorAll('.gallery-img-loading');
    let loadedCount = 0;
    const totalImages = images.length;

    // Load images progressively
    images.forEach((img, index) => {
        const src = img.dataset.src;
        if (!src) return;

        // Prioritize first 8 images (above fold)
        if (index < 8) {
            img.src = src;
        }

        // When image loads, remove blur
        img.onload = function() {
            loadedCount++;
            img.classList.remove('gallery-img-loading');
            img.classList.add('gallery-img-loaded');
        };

        // Use Intersection Observer for lazy loading the rest
        if (index >= 8 && 'IntersectionObserver' in window) {
            const observer = new IntersectionObserver((entries, obs) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        img.src = src;
                        obs.unobserve(entry.target);
                    }
                });
            }, { rootMargin: '100px' });
            observer.observe(img);
        } else if (index >= 8) {
            // Fallback for browsers without IntersectionObserver
            img.src = src;
        }
    });
});
</script>

{{ end }} 